parameters:
  - name: versionScript
    displayName: Version Script
    type: string
    default: lerna:version
  - name: publishScript
    displayName: Publish Script
    type: string
    default: lerna:publish
  - name: buildScript
    displayName: Build Script
    type: string
    default: nx:all:build
  - name: testScript
    displayName: Test Script
    type: string
    default: 'nx:all:test:cc'
  - name: lintScript
    displayName: Lint Script
    type: string
    default: 'nx:all:lint'
  - name: releaseBranch
    displayName: Release branch
    type: string
    default: main

steps:
  - template: init-workspace.yaml

  - script: git switch ${{parameters.releaseBranch}}
    displayName: Switch branch

  - script: git update-index --skip-worktree -- .npmrc
    displayName: Ignore .npmrc

  - script: |
      git config --global user.email "azuredevops_build_agent@vodafone.com"
      git config --global user.name "Azure DevOps Build Agent"
      echo "git-tag-version = false" >> .npmrc
      git update-index --assume-unchanged .npmrc
    displayName: Set git config

  - task: geeklearningio.gl-vsts-tasks-yarn.yarn-task.Yarn@2
    displayName: 'Lerna Bootstrap'
    inputs:
      Arguments: 'lerna:bootstrap'

  - task: geeklearningio.gl-vsts-tasks-yarn.yarn-task.Yarn@2
    displayName: 'Linting'
    inputs:
      Arguments: ${{parameters.lintScript}}

  - task: geeklearningio.gl-vsts-tasks-yarn.yarn-task.Yarn@2
    displayName: 'Tests'
    inputs:
      Arguments: ${{parameters.testScript}}

  - task: geeklearningio.gl-vsts-tasks-yarn.yarn-task.Yarn@2
    displayName: 'Lerna Version'
    inputs:
      Arguments: '${{parameters.versionScript}} --message="chore(ci): versions updated ***NO_CI***"'

  - script: |
      yarn ${{parameters.buildScript}}
    displayName: 'Build Affected Packages'

  - task: geeklearningio.gl-vsts-tasks-yarn.yarn-task.Yarn@2
    displayName: 'Lerna Publish'
    inputs:
      Arguments: ${{parameters.publishScript}}

  - script: git push origin HEAD:$(Build.SourceBranchName) --force --tags --porcelain
    displayName: Push version tags

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact - docs'
    inputs:
      PathtoPublish: ./packages/docsite
      ArtifactName: docs

  - task: PublishBuildArtifacts@1
    ## This task publishes the VSTS infrastructure documents for use later in the build and release. This is a required task.
    displayName: 'Publish Artifact: infrastructure'
    inputs:
      PathtoPublish: infrastructure
      ArtifactName: infrastructure
